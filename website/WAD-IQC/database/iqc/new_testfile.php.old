<?php 

require("../globals.php") ;
require("./common.php") ;
require("./php/includes/setup.php");

$pk=$_GET['pk'];

$executestring = sprintf("Location: http://%s%s/",$_SERVER['HTTP_HOST'],dirname($_SERVER['PHP_SELF']));


if(!empty($_POST['action']))
{
  
  $title=$_POST['title'];
  $firstname=$_POST['firstname'];
  $lastname=$_POST['lastname'];
  $address=$_POST['address'];
  $phone=$_POST['phone'];
  
  
  $table_analysemodule='analysemodule';
  $addStmt = "Insert into $table_analysemodule(description,filename,filepath) values ('%s','%s','%s')";
  $update_Stmt = "Update $table_analysemodule set description='%s',filename='%s',filepath='%s' where $table_analysemodule.pk='%d'";

  $delStmt = "delete from  $table_analysemodule where $table_analysemodule.pk='%d'";

  // Connect to the Database
  if (!($link=mysql_pconnect($hostName, $userName, $password))) {
  DisplayErrMsg(sprintf("error connecting to host %s, by user %s",$hostName, $userName)) ;
  exit() ;
  }

  // Select the Database
  if (!mysql_select_db($databaseName, $link)) {
     DisplayErrMsg(sprintf("Error in selecting %s database", $databaseName)) ;
     DisplayErrMsg(sprintf("error:%d %s", mysql_errno($link), mysql_error($link))) ;
     exit() ;
  }

  if ($analysemodule_ref<=0)
  { 
    if (!(mysql_query(sprintf($addStmt,$title,$firstname,$lastname,$address,$phone,$school),$link))) 
    {
      DisplayErrMsg(sprintf("Error in executing %s stmt", $stmt)) ;
      DisplayErrMsg(sprintf("error:%d %s", mysql_errno($link), mysql_error($link))) ;
      exit() ;
    }
  }
  if ($analysemodule_ref>0)
  { 
    if (!(mysql_query(sprintf($update_Stmt,$title,$firstname,$lastname,$address,$phone,$school,$analysemodule_ref),$link))) 
    {
      DisplayErrMsg(sprintf("Error in executing %s stmt", $stmt)) ;
      DisplayErrMsg(sprintf("error:%d %s", mysql_errno($link), mysql_error($link))) ;
      exit() ;
    }
  }








}

if (!empty($_POST['action']))
{
  $executestring.=sprintf("show_analysemodule.php?school=$school&t=%d",time());
  header($executestring);
  exit();
}




//////////////////////////////////////////////////////////////////////////////////////////
// if it will get to here it is either the first time or it returned from add/modify picture
///////////////////////////////////////////////////////////////////////////////////////////


$analysemodule = new Smarty_NM();




if ($analysemodule_ref<=0)
{
  $analysemodule->assign("submit_value","Add");  
}

if ($analysemodule_ref>0)
{
  $table_analysemodule='analysemodule';
  $analysemodule_Stmt = "SELECT * from $table_analysemodule where
  $table_analysemodule.analysemodule_ref='$analysemodule_ref' and
  $table_analysemodule.school='$school'";

  // Connect to the Database
  if (!($link=mysql_pconnect($hostName, $userName, $password))) {
     DisplayErrMsg(sprintf("error connecting to host %s, by user %s",$hostName, $userName)) ;
     exit() ;
  }

  // Select the Database
  if (!mysql_select_db($databaseName, $link)) {
    DisplayErrMsg(sprintf("Error in selecting %s database", $databaseName)) ;
    DisplayErrMsg(sprintf("error:%d %s", mysql_errno($link), mysql_error($link))) ;
    exit() ;
  }
  
  if (!($result_analysemodule= mysql_query($analysemodule_Stmt, $link))) {
     DisplayErrMsg(sprintf("Error in executing %s stmt", $mpc_class_Stmt)) ;
     DisplayErrMsg(sprintf("error:%d %s", mysql_errno($link), mysql_error($link))) ;
     exit() ;
  }
    
  $new = mysql_fetch_object($result_analysemodule);
  
  $analysemodule->assign("default_title",$new->title);
  $analysemodule->assign("default_fname",$new->firstname);
  $analysemodule->assign("default_lname",$new->lastname);
  $analysemodule->assign("default_address",$new->address);
  $analysemodule->assign("default_phone",$new->phone);
  
  mysql_free_result($result_analysemodule);
  
  $analysemodule->assign("submit_value","Update");
}

  $analysemodule->assign("action_new_analysemodule",sprintf("new_analysemodule.php?school=$school&analysemodule_ref=%d&t=%d",$analysemodule_ref,time()));

  
  $header=sprintf("MD for %s",$school);
  $analysemodule->assign("header",$header);

  $analysemodule->display("new_analysemodule.tpl");

   
?>












