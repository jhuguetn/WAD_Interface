<?php
require("../globals.php") ;
require("./common.php") ;
require("../../../php/includes/setup.php");

$v=$_GET['v'];
$school=$_GET['school'];
$department=$_GET['department'];
$school_year=$_GET['school_year'];
$class=$_GET['class'];
$grade=$_GET['grade'];

//$show_average='';
//if (!empty($_POST['show_average']))
//{
//  $show_average=$_POST['show_average'];
//}


if (!empty($_POST['term']))
{
  $term=$_POST['term'];
}

//if (!empty($_POST['factor']))
//{
//  $factor=$_POST['factor'];
//}

$table_student='student';
$table_school_student='school_student';
$table_department_student='department_student';
$table_class_student='class_student';
$table_subjects='subjects';

$table_school='school';
$table_year='year';
$table_department='department';
$table_grade='grade';
$table_calculation_report='calculation_report';
$table_subject='subject';

$table_skill='skill';
$table_score='score';

$table_marks='marks';
$table_subjects='subjects';
$table_category='category';

$table_teacher='teacher';
$table_teacher_year='teacher_year';
$table_teacher_department='teacher_department';
$table_teacher_subject='teacher_subject';

$student_Stmt = "SELECT * from $table_student, $table_school_student,
$table_department_student, $table_class_student where 
$table_school_student.school='$school' and
$table_department_student.department='$department' and 
$table_class_student.year='$school_year' and
$table_class_student.class='$class' and
$table_student.student_ref=$table_school_student.student_ref and
$table_school_student.school_ref=$table_department_student.school_ref and
$table_department_student.department_ref=$table_class_student.department_ref
order by $table_student.lastname, $table_student.firstname";

$subject_Stmt = "SELECT * from $table_school,$table_year,$table_department,$table_subject where
$table_school.school_ref=$table_year.school_ref and
$table_year.year_ref=$table_department.year_ref and
$table_department.department_ref=$table_subject.department_ref and
$table_school.school='$school' and 
$table_year.year='$school_year' and
$table_department.department='$department'
order by $table_subject.category, $table_subject.abreviation";

$subject_report_Stmt ="SELECT * from $table_subjects where
$table_subjects.subject='%s' and
$table_subjects.class_ref='%d'";

$report_Stmt ="SELECT * from $table_marks where
$table_marks.term='%s' and $table_marks.subjects_ref='%d'";


//$report_Stmt ="SELECT * from $table_marks,$table_subjects where
//$table_marks.subjects_ref=$table_subjects.subjects_ref and
//$table_marks.term='%s' and
//$table_subjects.subject='%s' and
//$table_subjects.class_ref='%d'";

$category_Stmt ="SELECT * from $table_category,$table_subjects where
$table_category.subjects_ref=$table_subjects.subjects_ref and
$table_category.term<='$term' and
$table_subjects.subject='%s' and
$table_subjects.class_ref='%d' and 
$table_category.skill='%s'";  

$teacher_Stmt="SELECT $table_teacher.initials from $table_teacher, $table_teacher_year,
$table_teacher_department, $table_teacher_subject where
$table_teacher.teacher_ref=$table_teacher_year.teacher_ref and
$table_teacher_year.year_ref=$table_teacher_department.year_ref and
$table_teacher_department.department_ref=$table_teacher_subject.department_ref and
$table_teacher_year.year='$school_year' and
$table_teacher_year.school='$school' and
$table_teacher_department.department='$department' and
$table_teacher_subject.subject='%s'";

$skill_Stmt="SELECT * from $table_year, $table_school, $table_skill 
where $table_school.school_ref=$table_year.school_ref and
$table_year.year_ref=$table_skill.year_ref and
$table_school.school='$school' and 
$table_year.year='$school_year'
order by $table_skill.number";

$score_Stmt="SELECT * from $table_year, $table_school, $table_score 
where $table_school.school_ref=$table_year.school_ref and
$table_year.year_ref=$table_score.year_ref and
$table_school.school='$school' and 
$table_year.year='$school_year'
order by $table_score.score";

$calculation_report_verify_Stmt = "SELECT * from $table_school, $table_year,
$table_department, $table_grade, $table_calculation_report where
$table_school.school_ref=$table_year.school_ref and
$table_year.year_ref=$table_department.year_ref and
$table_department.department_ref=$table_grade.department_ref and
$table_grade.grade_ref=$table_calculation_report.grade_ref and
$table_school.school='$school' and 
$table_year.year='$school_year' and
$table_department.department='$department' and
$table_grade.grade='$grade' and
$table_calculation_report.term='%d'";

// Connect to the Database
if (!($link=mysql_pconnect($hostName, $userName, $password))) {
   DisplayErrMsg(sprintf("error connecting to host %s, by user %s",
                             $hostName, $userName)) ;
   exit();
}

// Select the Database
if (!mysql_select_db($databaseName, $link)) {
   DisplayErrMsg(sprintf("Error in selecting %s database", $databaseName)) ;
   DisplayErrMsg(sprintf("error:%d %s", mysql_errno($link), mysql_error($link))) ;
   exit() ;
}
if (!($result_calculation_report=mysql_query(sprintf($calculation_report_verify_Stmt,$term),$link))) 
{
  DisplayErrMsg(sprintf("Error in executing %s stmt", $subject_Stmt)) ;
  DisplayErrMsg(sprintf("error:%d %s", mysql_errno($link), mysql_error($link))) ;
  exit() ;
}

$k=0;
while ($field_calculation_report = mysql_fetch_object($result_calculation_report))
{
  $k++;
  $factor=unserialize($field_calculation_report->factor);
  $alternative_tittle=$field_calculation_report->alternative_tittle;
  $show_average=$field_calculation_report->show_average;
  $honor_term=$field_calculation_report->honor_term;
}
if ($k==0)
{
  printf("No report data available, make sure you defined the report factors
  in the Report Card menu.");
  exit(1);
}

if (!($result_subject= mysql_query($subject_Stmt, $link))) {
   DisplayErrMsg(sprintf("Error in executing %s stmt", $subject_Stmt)) ;
   DisplayErrMsg(sprintf("error:%d %s", mysql_errno($link), mysql_error($link))) ;
   exit() ;
}

if (!($result_student= mysql_query($student_Stmt, $link))) {
   DisplayErrMsg(sprintf("Error in executing %s stmt", $student_Stmt)) ;
   DisplayErrMsg(sprintf("error:%d %s", mysql_errno($link), mysql_error($link))) ;
   exit() ;
}

//define default score
 
if (!($result_score= mysql_query($score_Stmt, $link))) {
 DisplayErrMsg(sprintf("Error in executing %s stmt", $subject_Stmt)) ;
 DisplayErrMsg(sprintf("error:%d %s", mysql_errno($link), mysql_error($link))) ;
 exit() ;
}
while($field_score = mysql_fetch_object($result_score))
{
  if ($field_score->selected_score=='on')
  {
    $default_selected_score=$field_score->score;
  }
} 
mysql_free_result($result_score);


//define skill array
if (!($result_skill= mysql_query($skill_Stmt, $link))) {
   DisplayErrMsg(sprintf("Error in executing %s stmt", $subject_Stmt)) ;
   DisplayErrMsg(sprintf("error:%d %s", mysql_errno($link), mysql_error($link))) ;
   exit() ;
}
$j=0;
while ($field_skill = mysql_fetch_object($result_skill))
{
  $skill_array[$j]=$field_skill->skill;
  $skill_ref_array[$j]=$field_skill->skill_ref;
  $j++;
}
mysql_free_result($result_skill); 
$skill_number=count($skill_array);

$j=0;
$subject_number=0;
while (($field = mysql_fetch_object($result_subject)))
{
  if ($j>0)
  { 
    if ($field->abreviation!=$subject_array[$j-1])
    {
      $subject_array[$j]=$field->abreviation;
      $j++;
    }
  }
  if ($j==0)
  { 
    $subject_array[$j]=$field->abreviation;
    $j++;
  }

}  
mysql_free_result($result_subject); 

if (!empty($subject_array))
{
  $subject_number=count($subject_array);
}

$table_content="";
$table_content_report="";

$j=0; // The header information will be defined during the first student row
while (($field_student = mysql_fetch_object($result_student)))
{
  $b=($j%2);
  if ($b==1)
  {
    $background=sprintf("#eaeaea");
  }
  if ($b==0)
  {
    $background=sprintf("white");  
  }
  $background_header=sprintf("#d8d8d8");
  $row_start='<tr>';
  if ($j==0) //header information
  {
    $header_subject_code=$row_start;
    $header_subject_code.=sprintf("<td colspan=\"2\" bgcolor=\"%s\" class=\"table_data\">%s %s</td>",$background_header,$school,$school_year);   
    $header_teacher=$row_start;
    $header_teacher.=sprintf("<td colspan=\"2\" bgcolor=\"%s\" class=\"table_data\">%s %s Term:%s</td>",$background_header,$department,$class,$term); 
  }
  $header_student=$row_start;
  
  $student = new Smarty_NM();
  $student->assign("firstname",$field_student->firstname);
  $student->assign("lastname",$field_student->lastname);
  $student->assign("background",$background);
  $header_student.=$student->fetch("report_student.tpl");
  $table_row='';

  $i=0;
  $average_sum=0;
  $average_number=0;
  while ($i<$subject_number)
  {
    //printf($teacher_Stmt,$subject_array[$i]);
    //exit();
    if (!($result_teacher= mysql_query(sprintf($teacher_Stmt,$subject_array[$i]),$link))) {
    DisplayErrMsg(sprintf("Error in executing %s stmt", $COTG_Stmt)) ;
    DisplayErrMsg(sprintf("error:%d %s", mysql_errno($link), mysql_error($link))) ;
    exit() ;
    }
    $tc=0;
    while ($field_teacher = mysql_fetch_object($result_teacher))
    {
      if ($tc>0)
      { 
        if ($field_teacher->initials!=$previous)
        {
          $teacher_array[$i].=sprintf(" and %s",$field_teacher->initials); 
          $previous=$field_teacher->initials;
        }
      }
      if ($tc==0)
      { 
        $teacher_array[$i]=sprintf("%s",$field_teacher->initials);
        $previous=$field_teacher->initials;
        $tc++;
      }
    }
    mysql_free_result($result_teacher);
    
    if ($j==0) //header information
    {
      $subject_code = new Smarty_NM();
      $subject_code->assign("subject",$subject_array[$i]);
      $subject_code->assign("background",$background_header); 
      $header_subject_code.= $subject_code->fetch("report_subject_code.tpl");
      
      $teacher_template = new Smarty_NM();
      $teacher_template->assign("teacher","&nbsp;");
      if (!empty($teacher_array[$i]))
      {
        $teacher_template->assign("teacher",$teacher_array[$i]);
      }
      $teacher_template->assign("background",$background_header);
      $header_teacher.= $teacher_template->fetch("report_teacher.tpl");
    }
    
    // loop for the terms in order to calculate the report
    
    $term_counter=1;
    
    //determining the subjects_ref
    if (!($result_subject_report= mysql_query(sprintf($subject_report_Stmt,$subject_array[$i],$field_student->class_ref),$link)))
    {
      DisplayErrMsg(sprintf("Error in executing %s stmt", $report_Stmt)) ;
      DisplayErrMsg(sprintf("error:%d %s", mysql_errno($link), mysql_error($link))) ;
      exit() ;
    }
    $field_subject_report = mysql_fetch_object($result_subject_report);
    $subjects_ref=$field_subject_report->subjects_ref;
    mysql_free_result($result_subject_report);

    while($term_counter<=$term)
    {
      if (!($result_report= mysql_query(sprintf($report_Stmt,$term_counter,$subjects_ref),$link)))
      {
        DisplayErrMsg(sprintf("Error in executing %s stmt", $report_Stmt)) ;
        DisplayErrMsg(sprintf("error:%d %s", mysql_errno($link), mysql_error($link))) ;
        exit() ;
      }
      $field_report = mysql_fetch_object($result_report);
      
      $term_value=0;
      sscanf($field_report->report,"%s",&$term_value);
      $report_list[$term_counter]=$term_value;
      
      mysql_free_result($result_report);
   
      $term_counter++;
     
    }
    
    $report_sheet="";
    $report_counter=1;
    $report_counter_stop=$term;
    if ($show_average=='on')
    {
      $report_counter_stop=$term+1;
    }
    while($report_counter<=$report_counter_stop)  //start
    {
      $report_m=0;
      $report_w=0;
      $term_counter=1;
      $term_counter_stop=$report_counter;
      if ($term_counter_stop>$term)
      {
        $term_counter_stop=$term;
      }
      while($term_counter<=$term_counter_stop)      
      {   
        if ($report_list[$term_counter]!='n.a.') 
        {
          $report_m=$report_m+($report_list[$term_counter]*$factor[$report_counter][$term_counter]);
          $report_w=$report_w+$factor[$report_counter][$term_counter];
        }
        $term_counter++;     
      }
      if ($i==0) //initialisation
      {
        $average_subjects_sum[$report_counter]=0;//$grade_average[$term_counter]=0;
        $average_subjects_number[$report_counter]=0;
      }

      $term_report[$report_counter]="n.a.";
      if (($report_m>0)&&($report_w>0))
      {
        $report_temp=($report_m/$report_w);
        $term_report[$report_counter]=sprintf("%.0f",$report_temp);
      }
      if ($report_counter<=$term)
      {
        $report_sheet.=sprintf("$report_title[$report_counter]:&nbsp;%s<br>",$term_report[$report_counter]);  
        if ($term_report[$report_counter]!='n.a.')
        {
          $average_subjects_sum[$report_counter]+=$term_report[$report_counter];
          $average_subjects_number[$report_counter]+=1;
        } 
      }
      if ($report_counter>$term)
      {
        $report_sheet.=sprintf("Av:&nbsp;%s<br>",$term_report[$report_counter]); 
        if ($term_report[$report_counter]!='n.a.')
        {
          $average_subjects_sum[$report_counter]+=$term_report[$report_counter];
          $average_subjects_number[$report_counter]+=1;
        } 
      }
      $report_counter++;
    }
    
    $report = new Smarty_NM();
    $report->assign("report",$report_sheet);
    $report->assign("background",$background);
    $header_student.=$report->fetch("report_report.tpl");
       
    //loop for the categories
    $counter=0;
    while ($counter<($skill_number))
    {
      if ($i==0)
      {
        $category_header[$counter]=$row_start;
        $category_template = new Smarty_NM();
        $category_template->assign("category",$skill_array[$counter]);
        $category_template->assign("background",$background);
        $category_header[$counter].=$category_template->fetch("report_category.tpl");
      }
      if (!($result_category= mysql_query(sprintf($category_Stmt,$subject_array[$i],$field_student->class_ref,$skill_array[$counter]),$link)))
      {
        DisplayErrMsg(sprintf("Error in executing %s stmt", $category_Stmt)) ;
        DisplayErrMsg(sprintf("error:%d %s", mysql_errno($link), mysql_error($link))) ;
        exit() ;
      }
      $score_value=$default_selected_score;
      $code_value="&nbsp;";
      while($field_category = mysql_fetch_object($result_category))
      {
        if ($field_category->score!='')
        {
          $score_value=$field_category->score;
        }
        if ($field_category->code!='')
        {
          $code_value=$field_category->code;
        }
      }
      mysql_free_result($result_category);
      
      $category_template = new Smarty_NM();
      $category_template->assign("score",$score_value);
      $category_template->assign("code",$code_value);
      $category_template->assign("background",$background);
      $category_header[$counter].=$category_template->fetch("report_category_score_code.tpl");
        
      $counter++;
    }
    $i++;
  } 
  //calculation of subject averages
  $report_sheet='';
  $report_counter=1;
  $report_counter_stop=$term;
  if ($show_average=='on')
  {
    $report_counter_stop=$term+1;
  }
  while($report_counter<=$report_counter_stop)  //start
  {
    $average_report_subject[$report_counter]='n.a.';
    if (( $average_subjects_sum[$report_counter]>0)&&($average_subjects_number[$report_counter]>0))
    {
      $temp=($average_subjects_sum[$report_counter]/$average_subjects_number[$report_counter]);
      $average_report_subject[$report_counter]=sprintf("%.0f",$temp);
    }
    $report_sheet.=sprintf("$report_title[$report_counter]:&nbsp;%s<br>",$average_report_subject[$report_counter]);  
    
    $report_counter++;
  }
  $report = new Smarty_NM();
  $report->assign("report",$report_sheet);
  $report->assign("background",$background);
  $header_student.=$report->fetch("report_report.tpl");
  
  $header_student.=sprintf("</tr>");
  // end calculation of subject averages


 
  //$header_student.=sprintf("</tr>");
  if ($j==0)
  {  
    $report = new Smarty_NM();
    $report->assign("report","Av");
    $report->assign("background",$background);
    $header_subject_code.=$report->fetch("report_report.tpl");
    $header_subject_code.=sprintf("</tr>");   
    $report = new Smarty_NM();
    $report->assign("report","&nbsp;");
    $report->assign("background",$background);
    $header_teacher.=$report->fetch("report_report.tpl");
    $header_teacher.=sprintf("</tr>");
  }
  if (($average_sum>0)&&($average_number>0))
  {
    $temp=($average_sum/$average_number);
    $average_report_subject=sprintf("%.0f",$temp);
  }
  $table_row.=$header_student;
  $counter=0;
  
  while ($counter<($skill_number))
  {
    $report = new Smarty_NM();
    $report->assign("report","&nbsp;");
    $report->assign("background",$background);
    $category_header[$counter].=$report->fetch("report_report.tpl");
    $category_header[$counter].=sprintf("</tr>");
    $table_row.=$category_header[$counter];
    $counter++;
  }
  $table_content.=$table_row;
  
  $c=(($j+1)%5);
  if (($c==0)&&($j!=0))
  {
    $report_data='';
    $report_data.=$header_subject_code;
    $report_data.=$header_teacher;
    $report_data.=$table_content;
    $data = new Smarty_NM();
    $data->assign("report_data",$report_data);
    $data->display("report_table_select.tpl");
    $table_content='';
  }
  $j++;
}
mysql_free_result($result_student); 

$c=1;
if ($c!=0)
{  //remaining rows that do not fit in a group
  $report_data='';
  $report_data.=$header_subject_code;
  $report_data.=$header_teacher;
  $report_data.=$table_content;
  $data = new Smarty_NM();
  $data->assign("report_data",$report_data);
  $data->display("report_table_select.tpl");
}  
 
?>
